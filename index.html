<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Recognition App</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/face-api.js/0.22.2/face-api.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            overflow-x: hidden;
        }

        .container {
            text-align: center;
            padding: 20px;
            max-width: 500px;
            width: 100%;
        }

        .title {
            font-size: 2rem;
            margin-bottom: 30px;
            font-weight: 300;
            letter-spacing: 1px;
        }

        .camera-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 0 auto 30px;
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .input-container {
            display: none;
            margin-bottom: 30px;
        }

        #nameInput {
            padding: 15px 20px;
            font-size: 1.1rem;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            width: 300px;
            max-width: 100%;
            text-align: center;
            outline: none;
            transition: all 0.3s ease;
        }

        #nameInput:focus {
            background: white;
            transform: scale(1.05);
        }

        #nameInput::placeholder {
            color: #666;
        }

        .result-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .user-name {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #fff;
        }

        .user-data {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.6;
        }

        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 10px;
            font-size: 0.9rem;
        }

        .status.loading {
            background: rgba(255, 193, 7, 0.3);
            color: #ffc107;
        }

        .status.ready {
            background: rgba(40, 167, 69, 0.3);
            color: #28a745;
        }

        .status.error {
            background: rgba(220, 53, 69, 0.3);
            color: #dc3545;
        }

        .status.demo {
            background: rgba(255, 193, 7, 0.3);
            color: #ffc107;
        }

        /* Debug panel */
        .debug-panel {
            position: fixed;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 10px;
            font-size: 0.8rem;
            max-height: 150px;
            overflow-y: auto;
            font-family: monospace;
            display: none;
        }

        .debug-panel.show {
            display: block;
        }

        .debug-toggle {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.7rem;
            cursor: pointer;
        }

        .device-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
        }

        /* Desktop styles */
        @media (min-width: 768px) {
            .camera-container {
                display: none;
            }
            
            .input-container {
                display: block;
            }
        }

        /* Mobile adjustments */
        @media (max-width: 767px) {
            .title {
                font-size: 1.5rem;
                margin-bottom: 20px;
            }
            
            .camera-container {
                width: 250px;
                height: 250px;
            }
            
            .container {
                padding: 15px;
            }
        }

        /* Loading animation */
        .loading-dots::after {
            content: '...';
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
            100% { content: '.'; }
        }
    </style>
</head>
<body>
    <div class="device-info" id="deviceInfo">Desktop Mode</div>
    <button class="debug-toggle" onclick="toggleDebug()">Debug</button>
    
    <div class="container">
        <h1 class="title">Face Recognition</h1>
        
        <!-- Camera cho mobile -->
        <div class="camera-container" id="cameraContainer">
            <video id="video" autoplay muted playsinline></video>
            <canvas id="canvas"></canvas>
        </div>
        
        <!-- Input cho desktop -->
        <div class="input-container" id="inputContainer">
            <input type="text" id="nameInput" placeholder="Nh·∫≠p t√™n ƒë·ªÉ t√¨m ki·∫øm...">
        </div>
        
        <div class="status loading" id="status">
            <span class="loading-dots">ƒêang kh·ªüi t·∫°o</span>
        </div>
        
        <div class="result-container" id="resultContainer" style="display: none;">
            <div class="user-name" id="userName"></div>
            <div class="user-data" id="userData"></div>
        </div>
        
        <div class="debug-panel" id="debugPanel"></div>
    </div>

    <script>
        class FaceRecognitionApp {
            constructor() {
                this.isMobile = window.innerWidth < 768;
                this.isModelLoaded = false;
                this.labeledDescriptors = [];
                this.excelData = {};
                this.currentDay = new Date().getDay(); // 0=Sunday, 1=Monday, etc.
                
                this.video = document.getElementById('video');
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas ? this.canvas.getContext('2d') : null;
                this.nameInput = document.getElementById('nameInput');
                this.status = document.getElementById('status');
                this.resultContainer = document.getElementById('resultContainer');
                this.userName = document.getElementById('userName');
                this.userData = document.getElementById('userData');
                this.deviceInfo = document.getElementById('deviceInfo');
                
                this.init();
            }
            
            async init() {
                this.updateDeviceInfo();
                await this.loadExcelData();
                
                if (this.isMobile) {
                    await this.initCamera();
                    await this.loadFaceModels();
                    await this.loadFaceDescriptors();
                    this.startFaceDetection();
                } else {
                    this.initDesktopMode();
                }
            }
            
            updateDeviceInfo() {
                this.deviceInfo.textContent = this.isMobile ? 'Mobile Mode' : 'Desktop Mode';
            }
            
            async loadExcelData() {
                try {
                    this.updateStatus('ƒêang t·∫£i d·ªØ li·ªáu Excel...', 'loading');
                    
                    // Th·ª≠ load file Excel th·∫≠t tr∆∞·ªõc
                    try {
                        const response = await fetch('data/InBold.xlsx');
                        if (response.ok) {
                            const arrayBuffer = await response.arrayBuffer();
                            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                            
                            this.excelData = {};
                            for (let i = 1; i < jsonData.length; i++) {
                                const row = jsonData[i];
                                if (row[0]) {
                                    this.excelData[row[0]] = [
                                        row[1] || 'Kh√¥ng c√≥ d·ªØ li·ªáu',
                                        row[2] || 'Kh√¥ng c√≥ d·ªØ li·ªáu', 
                                        row[3] || 'Kh√¥ng c√≥ d·ªØ li·ªáu',
                                        row[4] || 'Kh√¥ng c√≥ d·ªØ li·ªáu',
                                        row[5] || 'Kh√¥ng c√≥ d·ªØ li·ªáu'
                                    ];
                                }
                            }
                            
                            if (Object.keys(this.excelData).length > 0) {
                                console.log(`‚úì ƒê√£ load Excel th√†nh c√¥ng v·ªõi ${Object.keys(this.excelData).length} ng∆∞·ªùi d√πng`);
                                return;
                            }
                        }
                    } catch (excelError) {
                        console.warn('Kh√¥ng th·ªÉ load file Excel:', excelError);
                    }
                    
                    // Fallback: s·ª≠ d·ª•ng d·ªØ li·ªáu gi·∫£ l·∫≠p
                    console.log('‚ö† S·ª≠ d·ª•ng d·ªØ li·ªáu demo');
                    this.excelData = {
                        'Nguyen Van A': ['C√¥ng vi·ªác A1', 'C√¥ng vi·ªác A2', 'C√¥ng vi·ªác A3', 'C√¥ng vi·ªác A4', 'C√¥ng vi·ªác A5'],
                        'Tran Thi B': ['H·ªçp team', 'Ph√°t tri·ªÉn s·∫£n ph·∫©m', 'Testing', 'Review code', 'B√°o c√°o'],
                        'Le Van C': ['Thi·∫øt k·∫ø UI', 'Ph√¢n t√≠ch y√™u c·∫ßu', 'L·∫≠p tr√¨nh', 'Ki·ªÉm th·ª≠', 'Tri·ªÉn khai'],
                        'Pham Thi D': ['Marketing', 'Kh·∫£o s√°t th·ªã tr∆∞·ªùng', 'L√™n k·∫ø ho·∫°ch', 'Th·ª±c hi·ªán campaign', 'ƒê√°nh gi√° k·∫øt qu·∫£'],
                        'Hoang Van E': ['Qu·∫£n l√Ω d·ª± √°n', 'Ph√¢n b·ªï t√†i nguy√™n', 'Theo d√µi ti·∫øn ƒë·ªô', 'B√°o c√°o', 'T·ªëi ∆∞u quy tr√¨nh'],
                        'Demo User': ['Nhi·ªám v·ª• 1', 'Nhi·ªám v·ª• 2', 'Nhi·ªám v·ª• 3', 'Nhi·ªám v·ª• 4', 'Nhi·ªám v·ª• 5']
                    };
                    
                } catch (error) {
                    console.error('L·ªói khi t·∫£i Excel:', error);
                    this.updateStatus('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu Excel', 'error');
                    
                    // D·ªØ li·ªáu t·ªëi thi·ªÉu ƒë·ªÉ app v·∫´n ho·∫°t ƒë·ªông
                    this.excelData = {
                        'Demo User': ['C√¥ng vi·ªác demo', 'Test task', 'Sample work', 'Demo job', 'Test duty']
                    };
                }
            }
            
            async initCamera() {
                try {
                    this.updateStatus('ƒêang kh·ªüi ƒë·ªông camera...', 'loading');
                    
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'user',
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        }
                    });
                    
                    this.video.srcObject = stream;
                    
                    return new Promise((resolve) => {
                        this.video.onloadedmetadata = () => {
                            this.canvas.width = this.video.videoWidth;
                            this.canvas.height = this.video.videoHeight;
                            resolve();
                        };
                    });
                } catch (error) {
                    console.error('L·ªói camera:', error);
                    this.updateStatus('Kh√¥ng th·ªÉ truy c·∫≠p camera', 'error');
                }
            }
            
            async loadFaceModels() {
                try {
                    this.updateStatus('ƒêang t·∫£i m√¥ h√¨nh AI...', 'loading');
                    
                    await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdnjs.cloudflare.com/ajax/libs/face-api.js/0.22.2/models');
                    await faceapi.nets.faceLandmark68Net.loadFromUri('https://cdnjs.cloudflare.com/ajax/libs/face-api.js/0.22.2/models');
                    await faceapi.nets.faceRecognitionNet.loadFromUri('https://cdnjs.cloudflare.com/ajax/libs/face-api.js/0.22.2/models');
                    
                    this.isModelLoaded = true;
                } catch (error) {
                    console.error('L·ªói t·∫£i m√¥ h√¨nh:', error);
                    this.updateStatus('Kh√¥ng th·ªÉ t·∫£i m√¥ h√¨nh AI', 'error');
                }
            }
            
            async loadFaceDescriptors() {
                try {
                    this.updateStatus('ƒêang t·∫£i d·ªØ li·ªáu khu√¥n m·∫∑t...', 'loading');
                    
                    const faceNames = Object.keys(this.excelData);
                    this.labeledDescriptors = [];
                    let loadedCount = 0;
                    let failedCount = 0;
                    
                    // Th·ª≠ load ·∫£nh th·∫≠t t·ª´ th∆∞ m·ª•c data/face/
                    for (const name of faceNames) {
                        try {
                            this.updateStatus(`ƒêang x·ª≠ l√Ω ${name}... (${loadedCount + failedCount + 1}/${faceNames.length})`, 'loading');
                            
                            // Th·ª≠ c√°c ƒë·ªãnh d·∫°ng file kh√°c nhau
                            const possibleExtensions = ['jpg', 'jpeg', 'png', 'JPG', 'JPEG', 'PNG'];
                            let imageLoaded = false;
                            
                            for (const ext of possibleExtensions) {
                                try {
                                    const imagePath = `data/face/${name}.${ext}`;
                                    const img = await this.loadImage(imagePath);
                                    
                                    if (img) {
                                        const detection = await faceapi
                                            .detectSingleFace(img)
                                            .withFaceLandmarks()
                                            .withFaceDescriptor();
                                        
                                        if (detection && detection.descriptor) {
                                            this.labeledDescriptors.push(
                                                new faceapi.LabeledFaceDescriptors(name, [detection.descriptor])
                                            );
                                            loadedCount++;
                                            imageLoaded = true;
                                            console.log(`‚úì ƒê√£ load th√†nh c√¥ng: ${name}`);
                                            break;
                                        }
                                    }
                                } catch (err) {
                                    // Th·ª≠ extension ti·∫øp theo
                                    continue;
                                }
                            }
                            
                            if (!imageLoaded) {
                                failedCount++;
                                console.warn(`‚ö† Kh√¥ng t√¨m th·∫•y ·∫£nh cho: ${name}`);
                                
                                // T·∫°o descriptor gi·∫£ l·∫≠p ƒë·ªÉ app v·∫´n ho·∫°t ƒë·ªông
                                const fakeDescriptor = new Float32Array(128).map(() => Math.random() * 2 - 1);
                                this.labeledDescriptors.push(
                                    new faceapi.LabeledFaceDescriptors(name, [fakeDescriptor])
                                );
                            }
                            
                        } catch (error) {
                            failedCount++;
                            console.error(`‚ùå L·ªói x·ª≠ l√Ω ${name}:`, error);
                            
                            // T·∫°o descriptor gi·∫£ l·∫≠p khi c√≥ l·ªói
                            const fakeDescriptor = new Float32Array(128).map(() => Math.random() * 2 - 1);
                            this.labeledDescriptors.push(
                                new faceapi.LabeledFaceDescriptors(name, [fakeDescriptor])
                            );
                        }
                    }
                    
                    // B√°o c√°o k·∫øt qu·∫£
                    if (loadedCount > 0) {
                        this.updateStatus(`S·∫µn s√†ng nh·∫≠n di·ªán (${loadedCount}/${faceNames.length} ·∫£nh th·∫≠t)`, 'ready');
                        console.log(`üìä Th·ªëng k√™: ${loadedCount} ·∫£nh th·∫≠t, ${failedCount} ·∫£nh gi·∫£ l·∫≠p`);
                    } else {
                        this.updateStatus('S·∫µn s√†ng nh·∫≠n di·ªán (ch·∫ø ƒë·ªô demo)', 'ready');
                        console.log('‚ö† ƒêang ch·∫°y ·ªü ch·∫ø ƒë·ªô demo - kh√¥ng c√≥ ·∫£nh th·∫≠t n√†o ƒë∆∞·ª£c load');
                    }
                    
                } catch (error) {
                    console.error('L·ªói t·∫£i descriptor:', error);
                    this.updateStatus('L·ªói t·∫£i d·ªØ li·ªáu khu√¥n m·∫∑t - chuy·ªÉn sang ch·∫ø ƒë·ªô ch·ªâ nh·∫≠p t√™n', 'error');
                    
                    // T·∫Øt camera v√† chuy·ªÉn sang ch·∫ø ƒë·ªô desktop
                    if (this.video && this.video.srcObject) {
                        this.video.srcObject.getTracks().forEach(track => track.stop());
                    }
                    document.getElementById('cameraContainer').style.display = 'none';
                    document.getElementById('inputContainer').style.display = 'block';
                    this.initDesktopMode();
                }
            }
            
            // Helper function ƒë·ªÉ load ·∫£nh v·ªõi timeout
            loadImage(src) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    const timeout = setTimeout(() => {
                        reject(new Error('Timeout loading image'));
                    }, 5000); // 5 second timeout
                    
                    img.crossOrigin = 'anonymous';
                    img.onload = () => {
                        clearTimeout(timeout);
                        resolve(img);
                    };
                    img.onerror = () => {
                        clearTimeout(timeout);
                        reject(new Error('Failed to load image'));
                    };
                    img.src = src;
                });
            }
            
            async startFaceDetection() {
                if (!this.isModelLoaded) return;
                
                const faceMatcher = new faceapi.FaceMatcher(this.labeledDescriptors, 0.6);
                
                const detectFaces = async () => {
                    try {
                        const detections = await faceapi
                            .detectAllFaces(this.video, new faceapi.TinyFaceDetectorOptions())
                            .withFaceLandmarks()
                            .withFaceDescriptors();
                        
                        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                        
                        if (detections.length > 0) {
                            const resizedDetections = faceapi.resizeResults(detections, {
                                width: this.canvas.width,
                                height: this.canvas.height
                            });
                            
                            resizedDetections.forEach(detection => {
                                const match = faceMatcher.findBestMatch(detection.descriptor);
                                
                                // V·∫Ω khung nh·∫≠n di·ªán
                                const box = detection.detection.box;
                                this.ctx.strokeStyle = match.label !== 'unknown' ? '#4CAF50' : '#FF5722';
                                this.ctx.lineWidth = 3;
                                this.ctx.strokeRect(box.x, box.y, box.width, box.height);
                                
                                if (match.label !== 'unknown') {
                                    this.showUserInfo(match.label);
                                }
                            });
                        }
                    } catch (error) {
                        console.error('L·ªói nh·∫≠n di·ªán:', error);
                    }
                    
                    requestAnimationFrame(detectFaces);
                };
                
                detectFaces();
            }
            
            initDesktopMode() {
                this.updateStatus('Nh·∫≠p t√™n ƒë·ªÉ t√¨m ki·∫øm', 'ready');
                
                this.nameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const name = e.target.value.trim();
                        if (name) {
                            this.searchUser(name);
                        }
                    }
                });
                
                this.nameInput.addEventListener('input', (e) => {
                    const name = e.target.value.trim();
                    if (name.length > 2) {
                        this.searchUser(name);
                    } else {
                        this.resultContainer.style.display = 'none';
                    }
                });
            }
            
            searchUser(searchName) {
                const exactMatch = this.excelData[searchName];
                if (exactMatch) {
                    this.showUserInfo(searchName);
                    return;
                }
                
                // T√¨m ki·∫øm t∆∞∆°ng t·ª±
                const matches = Object.keys(this.excelData).filter(name => 
                    name.toLowerCase().includes(searchName.toLowerCase()) ||
                    this.removeAccents(name.toLowerCase()).includes(this.removeAccents(searchName.toLowerCase()))
                );
                
                if (matches.length > 0) {
                    this.showUserInfo(matches[0]);
                } else {
                    this.resultContainer.style.display = 'none';
                    this.updateStatus('Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng', 'error');
                }
            }
            
            removeAccents(str) {
                return str.normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '')
                    .replace(/ƒë/g, 'd')
                    .replace(/ƒê/g, 'D');
            }
            
            showUserInfo(name) {
                const userInfo = this.excelData[name];
                if (!userInfo) return;
                
                // T√≠nh to√°n d·ªØ li·ªáu theo th·ª© (Monday = 1, Tuesday = 2, ...)
                let dayIndex = this.currentDay - 1; // Convert Sunday=0 to Monday=0 base
                if (dayIndex < 0) dayIndex = 6; // Sunday becomes index 6
                if (dayIndex > 4) dayIndex = 4; // Weekend uses Friday data
                
                const dayNames = ['Th·ª© Hai', 'Th·ª© Ba', 'Th·ª© T∆∞', 'Th·ª© NƒÉm', 'Th·ª© S√°u'];
                const currentData = userInfo[dayIndex] || 'Kh√¥ng c√≥ d·ªØ li·ªáu';
                
                this.userName.textContent = name;
                this.userData.innerHTML = `
                    <strong>${dayNames[dayIndex]}:</strong><br>
                    ${currentData}
                `;
                
                this.resultContainer.style.display = 'block';
                this.updateStatus('ƒê√£ t√¨m th·∫•y!', 'ready');
            }
            
            updateStatus(message, type) {
                this.status.textContent = message;
                this.status.className = `status ${type}`;
            }
        }
        
        // Kh·ªüi ƒë·ªông app
        document.addEventListener('DOMContentLoaded', () => {
            new FaceRecognitionApp();
        });
        
        // Handle orientation change
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                location.reload();
            }, 500);
        });
        
        // Debug functions
        let debugLogs = [];
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            debugLogs.push(`[LOG] ${args.join(' ')}`);
            updateDebugPanel();
        };
        
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            debugLogs.push(`[ERROR] ${args.join(' ')}`);
            updateDebugPanel();
        };
        
        console.warn = function(...args) {
            originalConsoleWarn.apply(console, args);
            debugLogs.push(`[WARN] ${args.join(' ')}`);
            updateDebugPanel();
        };
        
        function updateDebugPanel() {
            const panel = document.getElementById('debugPanel');
            if (panel) {
                panel.innerHTML = debugLogs.slice(-10).join('<br>');
            }
        }
        
        function toggleDebug() {
            const panel = document.getElementById('debugPanel');
            panel.classList.toggle('show');
        }
    </script>
</body>
</html>
