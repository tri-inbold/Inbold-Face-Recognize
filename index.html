<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Recognition App</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/face-api.js/0.22.2/face-api.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            overflow-x: hidden;
        }

        .container {
            text-align: center;
            padding: 20px;
            max-width: 500px;
            width: 100%;
        }

        .title {
            font-size: 2rem;
            margin-bottom: 30px;
            font-weight: 300;
            letter-spacing: 1px;
        }

        .camera-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 0 auto 30px;
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .input-container {
            display: none;
            margin-bottom: 30px;
        }

        #nameInput {
            padding: 15px 20px;
            font-size: 1.1rem;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            width: 300px;
            max-width: 100%;
            text-align: center;
            outline: none;
            transition: all 0.3s ease;
        }

        #nameInput:focus {
            background: white;
            transform: scale(1.05);
        }

        #nameInput::placeholder {
            color: #666;
        }

        .result-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .user-name {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #fff;
        }

        .user-data {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.6;
        }

        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 10px;
            font-size: 0.9rem;
        }

        .status.loading {
            background: rgba(255, 193, 7, 0.3);
            color: #ffc107;
        }

        .status.ready {
            background: rgba(40, 167, 69, 0.3);
            color: #28a745;
        }

        .status.error {
            background: rgba(220, 53, 69, 0.3);
            color: #dc3545;
        }

        .device-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
        }

        /* Desktop styles */
        @media (min-width: 768px) {
            .camera-container {
                display: none;
            }
            
            .input-container {
                display: block;
            }
        }

        /* Mobile adjustments */
        @media (max-width: 767px) {
            .title {
                font-size: 1.5rem;
                margin-bottom: 20px;
            }
            
            .camera-container {
                width: 250px;
                height: 250px;
            }
            
            .container {
                padding: 15px;
            }
        }

        /* Loading animation */
        .loading-dots::after {
            content: '...';
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
            100% { content: '.'; }
        }
    </style>
</head>
<body>
    <div class="device-info" id="deviceInfo">Desktop Mode</div>
    
    <div class="container">
        <h1 class="title">Face Recognition</h1>
        
        <!-- Camera cho mobile -->
        <div class="camera-container" id="cameraContainer">
            <video id="video" autoplay muted playsinline></video>
            <canvas id="canvas"></canvas>
        </div>
        
        <!-- Input cho desktop -->
        <div class="input-container" id="inputContainer">
            <input type="text" id="nameInput" placeholder="Nhập tên để tìm kiếm...">
        </div>
        
        <div class="status loading" id="status">
            <span class="loading-dots">Đang khởi tạo</span>
        </div>
        
        <div class="result-container" id="resultContainer" style="display: none;">
            <div class="user-name" id="userName"></div>
            <div class="user-data" id="userData"></div>
        </div>
    </div>

    <script>
        class FaceRecognitionApp {
            constructor() {
                this.isMobile = window.innerWidth < 768;
                this.isModelLoaded = false;
                this.labeledDescriptors = [];
                this.excelData = {};
                this.currentDay = new Date().getDay(); // 0=Sunday, 1=Monday, etc.
                
                this.video = document.getElementById('video');
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas ? this.canvas.getContext('2d') : null;
                this.nameInput = document.getElementById('nameInput');
                this.status = document.getElementById('status');
                this.resultContainer = document.getElementById('resultContainer');
                this.userName = document.getElementById('userName');
                this.userData = document.getElementById('userData');
                this.deviceInfo = document.getElementById('deviceInfo');
                
                this.init();
            }
            
            async init() {
                this.updateDeviceInfo();
                await this.loadExcelData();
                
                if (this.isMobile) {
                    await this.initCamera();
                    await this.loadFaceModels();
                    await this.loadFaceDescriptors();
                    this.startFaceDetection();
                } else {
                    this.initDesktopMode();
                }
            }
            
            updateDeviceInfo() {
                this.deviceInfo.textContent = this.isMobile ? 'Mobile Mode' : 'Desktop Mode';
            }
            
            async loadExcelData() {
                try {
                    this.updateStatus('Đang tải dữ liệu Excel...', 'loading');
                    
                    // Giả lập dữ liệu Excel - trong thực tế bạn sẽ load từ data/InBold.xlsx
                    this.excelData = {
                        'Nguyen Van A': ['Công việc A1', 'Công việc A2', 'Công việc A3', 'Công việc A4', 'Công việc A5'],
                        'Tran Thi B': ['Họp team', 'Phát triển sản phẩm', 'Testing', 'Review code', 'Báo cáo'],
                        'Le Van C': ['Thiết kế UI', 'Phân tích yêu cầu', 'Lập trình', 'Kiểm thử', 'Triển khai'],
                        'Pham Thi D': ['Marketing', 'Khảo sát thị trường', 'Lên kế hoạch', 'Thực hiện campaign', 'Đánh giá kết quả'],
                        'Hoang Van E': ['Quản lý dự án', 'Phân bổ tài nguyên', 'Theo dõi tiến độ', 'Báo cáo', 'Tối ưu quy trình']
                    };
                    
                    // Uncomment phần này để load file Excel thực tế
                    /*
                    const response = await fetch('data/InBold.xlsx');
                    const arrayBuffer = await response.arrayBuffer();
                    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row[0]) {
                            this.excelData[row[0]] = [row[1], row[2], row[3], row[4], row[5]];
                        }
                    }
                    */
                    
                } catch (error) {
                    console.error('Lỗi khi tải Excel:', error);
                    this.updateStatus('Không thể tải dữ liệu Excel', 'error');
                }
            }
            
            async initCamera() {
                try {
                    this.updateStatus('Đang khởi động camera...', 'loading');
                    
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'user',
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        }
                    });
                    
                    this.video.srcObject = stream;
                    
                    return new Promise((resolve) => {
                        this.video.onloadedmetadata = () => {
                            this.canvas.width = this.video.videoWidth;
                            this.canvas.height = this.video.videoHeight;
                            resolve();
                        };
                    });
                } catch (error) {
                    console.error('Lỗi camera:', error);
                    this.updateStatus('Không thể truy cập camera', 'error');
                }
            }
            
            async loadFaceModels() {
                try {
                    this.updateStatus('Đang tải mô hình AI...', 'loading');
                    
                    await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdnjs.cloudflare.com/ajax/libs/face-api.js/0.22.2/models');
                    await faceapi.nets.faceLandmark68Net.loadFromUri('https://cdnjs.cloudflare.com/ajax/libs/face-api.js/0.22.2/models');
                    await faceapi.nets.faceRecognitionNet.loadFromUri('https://cdnjs.cloudflare.com/ajax/libs/face-api.js/0.22.2/models');
                    
                    this.isModelLoaded = true;
                } catch (error) {
                    console.error('Lỗi tải mô hình:', error);
                    this.updateStatus('Không thể tải mô hình AI', 'error');
                }
            }
            
            async loadFaceDescriptors() {
                try {
                    this.updateStatus('Đang tải dữ liệu khuôn mặt...', 'loading');
                    
                    // Giả lập dữ liệu - trong thực tế sẽ load từ thư mục data/face/
                    const faceNames = Object.keys(this.excelData);
                    this.labeledDescriptors = [];
                    
                    for (const name of faceNames) {
                        // Tạo descriptor giả lập - trong thực tế sẽ load và phân tích ảnh thật
                        const fakeDescriptor = new Float32Array(128).map(() => Math.random() * 2 - 1);
                        this.labeledDescriptors.push(
                            new faceapi.LabeledFaceDescriptors(name, [fakeDescriptor])
                        );
                    }
                    
                    
                    for (const name of faceNames) {
                        const img = await faceapi.fetchImage(`data/face/${name}.jpg`);
                        const detection = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();
                        if (detection) {
                            this.labeledDescriptors.push(
                                new faceapi.LabeledFaceDescriptors(name, [detection.descriptor])
                            );
                        }
                    }
                    
                    
                    this.updateStatus('Sẵn sàng nhận diện', 'ready');
                } catch (error) {
                    console.error('Lỗi tải descriptor:', error);
                    this.updateStatus('Không thể tải dữ liệu khuôn mặt', 'error');
                }
            }
            
            async startFaceDetection() {
                if (!this.isModelLoaded) return;
                
                const faceMatcher = new faceapi.FaceMatcher(this.labeledDescriptors, 0.6);
                
                const detectFaces = async () => {
                    try {
                        const detections = await faceapi
                            .detectAllFaces(this.video, new faceapi.TinyFaceDetectorOptions())
                            .withFaceLandmarks()
                            .withFaceDescriptors();
                        
                        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                        
                        if (detections.length > 0) {
                            const resizedDetections = faceapi.resizeResults(detections, {
                                width: this.canvas.width,
                                height: this.canvas.height
                            });
                            
                            resizedDetections.forEach(detection => {
                                const match = faceMatcher.findBestMatch(detection.descriptor);
                                
                                // Vẽ khung nhận diện
                                const box = detection.detection.box;
                                this.ctx.strokeStyle = match.label !== 'unknown' ? '#4CAF50' : '#FF5722';
                                this.ctx.lineWidth = 3;
                                this.ctx.strokeRect(box.x, box.y, box.width, box.height);
                                
                                if (match.label !== 'unknown') {
                                    this.showUserInfo(match.label);
                                }
                            });
                        }
                    } catch (error) {
                        console.error('Lỗi nhận diện:', error);
                    }
                    
                    requestAnimationFrame(detectFaces);
                };
                
                detectFaces();
            }
            
            initDesktopMode() {
                this.updateStatus('Nhập tên để tìm kiếm', 'ready');
                
                this.nameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const name = e.target.value.trim();
                        if (name) {
                            this.searchUser(name);
                        }
                    }
                });
                
                this.nameInput.addEventListener('input', (e) => {
                    const name = e.target.value.trim();
                    if (name.length > 2) {
                        this.searchUser(name);
                    } else {
                        this.resultContainer.style.display = 'none';
                    }
                });
            }
            
            searchUser(searchName) {
                const exactMatch = this.excelData[searchName];
                if (exactMatch) {
                    this.showUserInfo(searchName);
                    return;
                }
                
                // Tìm kiếm tương tự
                const matches = Object.keys(this.excelData).filter(name => 
                    name.toLowerCase().includes(searchName.toLowerCase()) ||
                    this.removeAccents(name.toLowerCase()).includes(this.removeAccents(searchName.toLowerCase()))
                );
                
                if (matches.length > 0) {
                    this.showUserInfo(matches[0]);
                } else {
                    this.resultContainer.style.display = 'none';
                    this.updateStatus('Không tìm thấy người dùng', 'error');
                }
            }
            
            removeAccents(str) {
                return str.normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '')
                    .replace(/đ/g, 'd')
                    .replace(/Đ/g, 'D');
            }
            
            showUserInfo(name) {
                const userInfo = this.excelData[name];
                if (!userInfo) return;
                
                // Tính toán dữ liệu theo thứ (Monday = 1, Tuesday = 2, ...)
                let dayIndex = this.currentDay - 1; // Convert Sunday=0 to Monday=0 base
                if (dayIndex < 0) dayIndex = 6; // Sunday becomes index 6
                if (dayIndex > 4) dayIndex = 4; // Weekend uses Friday data
                
                const dayNames = ['Thứ Hai', 'Thứ Ba', 'Thứ Tư', 'Thứ Năm', 'Thứ Sáu'];
                const currentData = userInfo[dayIndex] || 'Không có dữ liệu';
                
                this.userName.textContent = name;
                this.userData.innerHTML = `
                    <strong>${dayNames[dayIndex]}:</strong><br>
                    ${currentData}
                `;
                
                this.resultContainer.style.display = 'block';
                this.updateStatus('Đã tìm thấy!', 'ready');
            }
            
            updateStatus(message, type) {
                this.status.textContent = message;
                this.status.className = `status ${type}`;
            }
        }
        
        // Khởi động app
        document.addEventListener('DOMContentLoaded', () => {
            new FaceRecognitionApp();
        });
        
        // Handle orientation change
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                location.reload();
            }, 500);
        });
    </script>
</body>
</html>
