<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InBold Face Recognition</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; background-color: #f0f2f5; color: #333; display: flex; justify-content: center; align-items: center; min-height: 100vh; text-align: center; }
        .app-container { padding: 20px; max-width: 90vw; }
        #loader { font-size: 1.2em; font-weight: bold; }
        .camera-view { position: relative; width: 300px; height: 300px; border-radius: 50%; overflow: hidden; margin: 20px auto; border: 5px solid #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.1); background-color: #000; }
        #video { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scaleX(-1); min-width: 100%; min-height: 100%; width: auto; height: auto; }
        #desktop-container { margin: 40px auto; }
        #name-input { padding: 15px; font-size: 1.2em; width: 300px; border-radius: 30px; border: 1px solid #ccc; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        #info-container { margin-top: 20px; }
        #user-name { font-size: 2em; margin-bottom: 10px; color: #0056b3; word-wrap: break-word; }
        #user-info { font-size: 1.2em; min-height: 50px; word-wrap: break-word; }
        .hidden { display: none !important; }
        #snapshot-btn { 
            display: block; margin: 20px auto 0; padding: 12px 25px; font-size: 1.1em; font-weight: bold; color: #fff; background-color: #007bff; border: none; border-radius: 25px; cursor: pointer; transition: background-color 0.2s;
        }
        #snapshot-btn:hover { background-color: #0056b3; }
        #snapshot-btn:disabled { background-color: #6c757d; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="app-container">
        <div id="loader">ƒêang t·∫£i model v√† d·ªØ li·ªáu...</div>
        
        <!-- C√°c th√†nh ph·∫ßn giao di·ªán -->
        <div id="camera-container" class="hidden">
            <div class="camera-view">
                <video id="video" width="720" height="560" autoplay muted playsinline></video>
                <canvas id="snapshot-canvas" class="hidden"></canvas> <!-- Canvas ·∫©n ƒë·ªÉ ch·ª•p ·∫£nh -->
            </div>
            <button id="snapshot-btn">Ch·ª•p & Nh·∫≠n di·ªán</button>
        </div>

        <div id="desktop-container" class="hidden">
            <input type="text" id="name-input" placeholder="Nh·∫≠p t√™n v√† nh·∫•n Enter...">
        </div>

        <div id="info-container">
            <h2 id="user-name">...</h2>
            <p id="user-info">Vui l√≤ng h∆∞·ªõng camera v√†o khu√¥n m·∫∑t ho·∫∑c nh·∫≠p t√™n</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const video = document.getElementById('video');
            const canvas = document.getElementById('snapshot-canvas');
            const snapshotBtn = document.getElementById('snapshot-btn');
            const loader = document.getElementById('loader');
            const cameraContainer = document.getElementById('camera-container');
            const desktopContainer = document.getElementById('desktop-container');
            const nameInput = document.getElementById('name-input');
            const userNameDisplay = document.getElementById('user-name');
            const userInfoDisplay = document.getElementById('user-info');

            let allUsersData = [];
            let faceMatcher = null;
            const MODEL_URL = 'models';

            // --- C√ÅC H√ÄM TI·ªÜN √çCH ---
            function removeDiacritics(str) {
                if (!str) return '';
                return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/ƒë/g, 'd').replace(/ƒê/g, 'D');
            }

            // --- C√ÅC B∆Ø·ªöC KH·ªûI T·∫†O ---
            async function loadModels() {
                console.log('B·∫Øt ƒë·∫ßu t·∫£i models...');
                await Promise.all([
                    faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
                console.log('T·∫£i models th√†nh c√¥ng');
            }

            async function loadUserDataFromExcel() {
                console.log('B·∫Øt ƒë·∫ßu t·∫£i file Excel...');
                const response = await fetch('data/InBold.xlsx');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                allUsersData = XLSX.utils.sheet_to_json(worksheet);
                if (allUsersData.length === 0) throw new Error("File Excel kh√¥ng c√≥ d·ªØ li·ªáu.");
                console.log(`T·∫£i Excel th√†nh c√¥ng: ${allUsersData.length} d√≤ng d·ªØ li·ªáu`);
            }

            async function createFaceMatcher() {
                console.log(`B·∫Øt ƒë·∫ßu x·ª≠ l√Ω ${allUsersData.length} ·∫£nh...`);
                loader.innerText = `ƒêang x·ª≠ l√Ω ${allUsersData.length} ·∫£nh...`;
                const nameColumn = Object.keys(allUsersData[0])[0];
                const labeledFaceDescriptors = [];

                for (let index = 0; index < allUsersData.length; index++) {
                    const user = allUsersData[index];
                    const nameWithDiacritics = user[nameColumn];
                    if (!nameWithDiacritics) continue;
                    
                    const nameWithoutDiacritics = removeDiacritics(nameWithDiacritics);
                    const imgUrl = `data/face/${nameWithoutDiacritics}.jpg`;
                    try {
                        const img = await faceapi.fetchImage(imgUrl);
                        const detections = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();
                        if (detections) {
                            labeledFaceDescriptors.push(new faceapi.LabeledFaceDescriptors(nameWithDiacritics, [detections.descriptor]));
                        }
                        loader.innerText = `ƒêang x·ª≠ l√Ω ·∫£nh: ${index + 1}/${allUsersData.length}`;
                    } catch (e) {
                        console.error(`L·ªói t·∫£i ho·∫∑c x·ª≠ l√Ω ·∫£nh ${imgUrl}:`, e);
                    }
                }
                
                console.log(`Ho√†n th√†nh! X·ª≠ l√Ω th√†nh c√¥ng ${labeledFaceDescriptors.length}/${allUsersData.length} ·∫£nh.`);
                if (labeledFaceDescriptors.length > 0) {
                    faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.55);
                }
            }

            // --- LOGIC HI·ªÇN TH·ªä V√Ä ƒêI·ªÄU KHI·ªÇN ---
            function startCamera() {
                console.log('Kh·ªüi ƒë·ªông camera...');
                navigator.mediaDevices.getUserMedia({ video: {} })
                    .then(stream => { video.srcObject = stream; console.log('Camera kh·ªüi ƒë·ªông th√†nh c√¥ng'); })
                    .catch(err => { console.error('L·ªói camera:', err); loader.innerText = 'L·ªói! Kh√¥ng th·ªÉ truy c·∫≠p camera.'; });
            }

            function displayUserInfo(name) {
                if (name === 'unknown') {
                    userNameDisplay.innerText = 'Kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c';
                    userInfoDisplay.innerText = 'Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c ƒë·∫£m b·∫£o √°nh s√°ng t·ªët.';
                    return;
                }

                const nameColumn = Object.keys(allUsersData[0])[0];
                const user = allUsersData.find(u => u[nameColumn] && u[nameColumn].toLowerCase() === name.toLowerCase());
                if (user) {
                    const today = new Date().getDay();
                    const dayMapping = ['Ch·ªß Nh·∫≠t', 'Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7'];
                    const currentDayKey = (today >= 1 && today <= 5) ? dayMapping[today] : 'Th·ª© 2';
                    userNameDisplay.innerText = user[nameColumn];
                    userInfoDisplay.innerText = user[currentDayKey] || 'Kh√¥ng c√≥ th√¥ng tin cho ng√†y h√¥m nay.';
                }
            }

            // --- LOGIC NH·∫¨N DI·ªÜN ---

            // Ch·∫ø ƒë·ªô 1: V√≤ng l·∫∑p th·ªùi gian th·ª±c
            async function runRealtimeDetection() {
                console.log('üîç ƒêang qu√©t khu√¥n m·∫∑t (real-time)...');
                if (video.paused || video.ended) {
                    return; // D·ª´ng n·∫øu video kh√¥ng ch·∫°y
                }
                
                const detection = await faceapi.detectSingleFace(video).withFaceLandmarks().withFaceDescriptor();
                
                if (detection && faceMatcher) {
                    console.log('‚úÖ Ph√°t hi·ªán khu√¥n m·∫∑t (real-time)!');
                    const bestMatch = faceMatcher.findBestMatch(detection.descriptor);
                    console.log(`üéØ K·∫øt qu·∫£: ${bestMatch.label} (ƒë·ªô sai kh√°c: ${bestMatch.distance.toFixed(2)})`);
                    displayUserInfo(bestMatch.label);
                }
                
                // L√™n l·ªãch cho l·∫ßn qu√©t ti·∫øp theo. C√°ch n√†y an to√†n h∆°n setInterval.
                setTimeout(() => runRealtimeDetection(), 1500);
            }

            // Ch·∫ø ƒë·ªô 2: Nh·∫≠n di·ªán qua ·∫£nh ch·ª•p
            async function runSnapshotDetection() {
                if (!faceMatcher) return;

                console.log('üì∏ B·∫Øt ƒë·∫ßu ch·ª•p v√† nh·∫≠n di·ªán...');
                snapshotBtn.disabled = true;
                snapshotBtn.innerText = 'ƒêang x·ª≠ l√Ω...';
                
                const context = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                const detection = await faceapi.detectSingleFace(canvas).withFaceLandmarks().withFaceDescriptor();
                
                if (detection) {
                    console.log('‚úÖ Ph√°t hi·ªán khu√¥n m·∫∑t (snapshot)!');
                    const bestMatch = faceMatcher.findBestMatch(detection.descriptor);
                    console.log(`üéØ K·∫øt qu·∫£: ${bestMatch.label} (ƒë·ªô sai kh√°c: ${bestMatch.distance.toFixed(2)})`);
                    displayUserInfo(bestMatch.label);
                } else {
                    console.log('‚ùå Kh√¥ng t√¨m th·∫•y khu√¥n m·∫∑t trong ·∫£nh ch·ª•p.');
                    displayUserInfo('unknown');
                }
                
                snapshotBtn.disabled = false;
                snapshotBtn.innerText = 'Ch·ª•p & Nh·∫≠n di·ªán';
            }

            // --- H√ÄM CH√çNH ---
            async function main() {
                try {
                    // T·∫£i t·∫•t c·∫£ d·ªØ li·ªáu c·∫ßn thi·∫øt
                    await Promise.all([loadModels(), loadUserDataFromExcel()]);
                    await createFaceMatcher();

                    if (!faceMatcher) {
                        loader.innerText = "L·ªói: Kh√¥ng th·ªÉ kh·ªüi t·∫°o b·ªô nh·∫≠n di·ªán. Vui l√≤ng ki·ªÉm tra l·∫°i ·∫£nh.";
                        return;
                    }

                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    
                    if (isMobile) {
                        cameraContainer.classList.remove('hidden');
                        loader.classList.add('hidden');
                        startCamera();
                        
                        // K√≠ch ho·∫°t v√≤ng l·∫∑p th·ªùi gian th·ª±c khi video b·∫Øt ƒë·∫ßu ch·∫°y
                        video.addEventListener('play', () => {
                            console.log('Video ƒë√£ b·∫Øt ƒë·∫ßu. K√≠ch ho·∫°t nh·∫≠n di·ªán th·ªùi gian th·ª±c.');
                            runRealtimeDetection(); 
                        });
                        
                        // G√°n s·ª± ki·ªán cho n√∫t ch·ª•p ·∫£nh
                        snapshotBtn.addEventListener('click', runSnapshotDetection);

                    } else { // Ch·∫ø ƒë·ªô Desktop
                        desktopContainer.classList.remove('hidden');
                        loader.classList.add('hidden');
                        const nameColumn = Object.keys(allUsersData[0])[0];
                        nameInput.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') {
                                const name = nameInput.value.trim();
                                if (name) {
                                    const userFound = allUsersData.find(u => 
                                        u[nameColumn] && (u[nameColumn].toLowerCase() === name.toLowerCase() || removeDiacritics(u[nameColumn]).toLowerCase() === name.toLowerCase())
                                    );
                                    if (userFound) {
                                        displayUserInfo(userFound[nameColumn]);
                                    } else {
                                        userNameDisplay.innerText = 'Kh√¥ng t√¨m th·∫•y';
                                        userInfoDisplay.innerText = 'Vui l√≤ng ki·ªÉm tra l·∫°i t√™n.';
                                    }
                                }
                            }
                        });
                    }
                } catch (error) {
                    console.error("L·ªói nghi√™m tr·ªçng khi kh·ªüi t·∫°o ·ª©ng d·ª•ng:", error);
                    loader.innerText = `L·ªói: ${error.message}`;
                }
            }
            
            main();
        });
    </script>
</body>
</html>
