<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InBold Face Recognition - Debug</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; background-color: #f0f2f5; color: #333; display: flex; justify-content: center; align-items: center; min-height: 100vh; text-align: center; }
        .app-container { padding: 20px; max-width: 90vw; }
        #loader { font-size: 1.2em; font-weight: bold; }
        .camera-view { position: relative; width: 300px; height: 300px; border-radius: 50%; overflow: hidden; margin: 20px auto; border: 5px solid #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.1); background-color: #000; }
        #video { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scaleX(-1); min-width: 100%; min-height: 100%; width: auto; height: auto; }
        #desktop-container { margin: 40px auto; }
        #name-input { padding: 15px; font-size: 1.2em; width: 300px; border-radius: 30px; border: 1px solid #ccc; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        #info-container { margin-top: 30px; }
        #user-name { font-size: 2em; margin-bottom: 10px; color: #0056b3; word-wrap: break-word; }
        #user-info { font-size: 1.2em; min-height: 50px; word-wrap: break-word; }
        .hidden { display: none !important; }
        #debug-info { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            border-radius: 5px; 
            padding: 10px; 
            margin: 20px 0; 
            font-family: monospace; 
            font-size: 12px; 
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div id="loader">ƒêang t·∫£i model v√† d·ªØ li·ªáu...</div>
        <div id="debug-info"></div>
        <div id="camera-container" class="hidden">
            <div class="camera-view">
                <video id="video" width="720" height="560" autoplay muted playsinline></video>
            </div>
        </div>
        <div id="desktop-container" class="hidden">
            <input type="text" id="name-input" placeholder="Nh·∫≠p t√™n v√† nh·∫•n Enter...">
        </div>
        <div id="info-container">
            <h2 id="user-name">...</h2>
            <p id="user-info">Vui l√≤ng h∆∞·ªõng camera v√†o khu√¥n m·∫∑t ho·∫∑c nh·∫≠p t√™n</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const video = document.getElementById('video');
            const loader = document.getElementById('loader');
            const debugInfo = document.getElementById('debug-info');
            const cameraContainer = document.getElementById('camera-container');
            const desktopContainer = document.getElementById('desktop-container');
            const nameInput = document.getElementById('name-input');
            const userNameDisplay = document.getElementById('user-name');
            const userInfoDisplay = document.getElementById('user-info');

            let allUsersData = [];
            const MODEL_URL = 'models';

            // Debug function
            function addDebugMessage(message) {
                console.log(message);
                debugInfo.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
                debugInfo.scrollTop = debugInfo.scrollHeight;
            }

            function removeDiacritics(str) {
                if (!str) return '';
                return str
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '')
                    .replace(/ƒë/g, 'd')
                    .replace(/ƒê/g, 'D');
            }

            async function loadModels() {
                try {
                    addDebugMessage('B·∫Øt ƒë·∫ßu t·∫£i models...');
                    await Promise.all([
                        faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                        faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                        faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                    ]);
                    addDebugMessage('‚úÖ T·∫£i models th√†nh c√¥ng');
                } catch (error) {
                    addDebugMessage(`‚ùå L·ªói t·∫£i models: ${error.message}`);
                    loader.innerText = 'L·ªói: Kh√¥ng th·ªÉ t·∫£i model. Vui l√≤ng ki·ªÉm tra l·∫°i th∆∞ m·ª•c models.';
                    throw error;
                }
            }

            async function loadUserDataFromExcel() {
                try {
                    addDebugMessage('B·∫Øt ƒë·∫ßu t·∫£i file Excel...');
                    const response = await fetch('data/InBold.xlsx');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const arrayBuffer = await response.arrayBuffer();
                    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    // Th·ª≠ nhi·ªÅu c√°ch ƒë·ªçc d·ªØ li·ªáu
                    addDebugMessage(`Sheet name: ${sheetName}`);
                    
                    // Ph∆∞∆°ng ph√°p 1: ƒê·ªçc b√¨nh th∆∞·ªùng
                    allUsersData = XLSX.utils.sheet_to_json(worksheet);
                    addDebugMessage(`Ph∆∞∆°ng ph√°p 1 - S·ªë d√≤ng: ${allUsersData.length}`);
                    
                    if (allUsersData.length > 0) {
                        addDebugMessage(`C√°c c·ªôt c√≥ s·∫µn: [${Object.keys(allUsersData[0]).join(', ')}]`);
                        addDebugMessage(`D√≤ng ƒë·∫ßu ti√™n: ${JSON.stringify(allUsersData[0])}`);
                    } else {
                        // Ph∆∞∆°ng ph√°p 2: ƒê·ªçc v·ªõi header t√πy ch·ªânh
                        addDebugMessage('Th·ª≠ ph∆∞∆°ng ph√°p 2 - ƒë·ªçc v·ªõi header t·ª´ d√≤ng 2...');
                        allUsersData = XLSX.utils.sheet_to_json(worksheet, { range: 1 });
                        addDebugMessage(`Ph∆∞∆°ng ph√°p 2 - S·ªë d√≤ng: ${allUsersData.length}`);
                        
                        if (allUsersData.length > 0) {
                            addDebugMessage(`C√°c c·ªôt (method 2): [${Object.keys(allUsersData[0]).join(', ')}]`);
                        }
                    }
                    
                    // Ph∆∞∆°ng ph√°p 3: ƒê·ªçc raw data ƒë·ªÉ debug
                    const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    addDebugMessage(`Raw data - ${rawData.length} d√≤ng:`);
                    for (let i = 0; i < Math.min(5, rawData.length); i++) {
                        addDebugMessage(`D√≤ng ${i + 1}: [${rawData[i].join(' | ')}]`);
                    }
                    
                    if (allUsersData.length === 0) {
                        throw new Error("File Excel kh√¥ng c√≥ d·ªØ li·ªáu ho·∫∑c sai ƒë·ªãnh d·∫°ng.");
                    }
                    
                    addDebugMessage(`‚úÖ T·∫£i Excel th√†nh c√¥ng: ${allUsersData.length} d√≤ng d·ªØ li·ªáu`);
                    
                } catch (error) {
                    addDebugMessage(`‚ùå L·ªói t·∫£i Excel: ${error.message}`);
                    loader.innerText = 'L·ªói: Kh√¥ng th·ªÉ t·∫£i file InBold.xlsx.';
                    throw error;
                }
            }

            async function createLabeledFaceDescriptors() {
                if (!allUsersData || allUsersData.length === 0) {
                    addDebugMessage('‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu user ƒë·ªÉ x·ª≠ l√Ω');
                    return [];
                }
                
                addDebugMessage(`B·∫Øt ƒë·∫ßu x·ª≠ l√Ω ${allUsersData.length} ·∫£nh...`);
                loader.innerText = `ƒêang x·ª≠ l√Ω ${allUsersData.length} ·∫£nh...`;
                
                const labeledFaceDescriptors = [];
                
                // T√¨m t√™n c·ªôt ch·ª©a h·ªç t√™n (flexible)
                let nameColumn = null;
                if (allUsersData.length > 0) {
                    const possibleColumns = ['T√™n', 'H·ªç t√™n', 'Ho ten', 'Name', 'Ten', 'Full Name', 'H·ªç v√† t√™n'];
                    for (const col of possibleColumns) {
                        if (allUsersData[0].hasOwnProperty(col)) {
                            nameColumn = col;
                            addDebugMessage(`‚úÖ T√¨m th·∫•y c·ªôt t√™n: "${nameColumn}"`);
                            break;
                        }
                    }
                    // N·∫øu kh√¥ng t√¨m th·∫•y, l·∫•y c·ªôt ƒë·∫ßu ti√™n
                    if (!nameColumn) {
                        const firstKey = Object.keys(allUsersData[0])[0];
                        nameColumn = firstKey;
                        addDebugMessage(`‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y c·ªôt t√™n chu·∫©n, s·ª≠ d·ª•ng c·ªôt: "${firstKey}"`);
                    }
                }
                
                for (let index = 0; index < allUsersData.length; index++) {
                    const user = allUsersData[index];
                    const nameWithDiacritics = user[nameColumn];
                    
                    if (!nameWithDiacritics || nameWithDiacritics.toString().trim() === '') {
                        addDebugMessage(`‚ö†Ô∏è B·ªè qua d√≤ng ${index + 1}: Kh√¥ng c√≥ t√™n (gi√° tr·ªã: "${nameWithDiacritics}")`);
                        addDebugMessage(`   D·ªØ li·ªáu d√≤ng: ${JSON.stringify(user)}`);
                        continue;
                    }

                    const nameWithoutDiacritics = removeDiacritics(nameWithDiacritics);
                    const imgUrl = `data/face/${nameWithoutDiacritics}.jpg`;
                    
                    addDebugMessage(`X·ª≠ l√Ω ${index + 1}/${allUsersData.length}: "${nameWithDiacritics}" -> "${nameWithoutDiacritics}.jpg"`);

                    try {
                        // Ki·ªÉm tra xem file c√≥ t·ªìn t·∫°i kh√¥ng
                        const imgResponse = await fetch(imgUrl);
                        if (!imgResponse.ok) {
                            addDebugMessage(`‚ùå Kh√¥ng t√¨m th·∫•y file: ${imgUrl} (Status: ${imgResponse.status})`);
                            continue;
                        }
                        
                        const img = await faceapi.fetchImage(imgUrl);
                        addDebugMessage(`‚úÖ T·∫£i ·∫£nh th√†nh c√¥ng: ${imgUrl}`);
                        
                        const detections = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();
                        
                        if (detections) {
                            labeledFaceDescriptors.push(new faceapi.LabeledFaceDescriptors(nameWithDiacritics, [detections.descriptor]));
                            addDebugMessage(`‚úÖ Ph√°t hi·ªán khu√¥n m·∫∑t th√†nh c√¥ng: "${nameWithDiacritics}"`);
                        } else {
                            addDebugMessage(`‚ùå Kh√¥ng ph√°t hi·ªán ƒë∆∞·ª£c khu√¥n m·∫∑t trong: ${imgUrl}`);
                        }
                        
                        loader.innerText = `ƒêang x·ª≠ l√Ω ·∫£nh: ${index + 1}/${allUsersData.length}`;
                        
                    } catch (e) {
                        addDebugMessage(`‚ùå L·ªói x·ª≠ l√Ω "${nameWithDiacritics}": ${e.message}`);
                    }
                }
                
                addDebugMessage(`üéâ Ho√†n th√†nh! X·ª≠ l√Ω th√†nh c√¥ng ${labeledFaceDescriptors.length}/${allUsersData.length} ·∫£nh`);
                return labeledFaceDescriptors;
            }

            function startCamera() {
                addDebugMessage('Kh·ªüi ƒë·ªông camera...');
                navigator.mediaDevices.getUserMedia({ video: {} })
                    .then(stream => { 
                        video.srcObject = stream;
                        addDebugMessage('‚úÖ Camera kh·ªüi ƒë·ªông th√†nh c√¥ng');
                    })
                    .catch(err => {
                        addDebugMessage(`‚ùå L·ªói camera: ${err.message}`);
                        loader.innerText = 'L·ªói! Kh√¥ng th·ªÉ truy c·∫≠p camera. Vui l√≤ng c·∫•p quy·ªÅn.';
                    });
            }

            function displayUserInfo(name) {
                // T√¨m ki·∫øm linh ho·∫°t v·ªõi t√™n c·ªôt
                let nameColumn = 'T√™n';
                if (allUsersData.length > 0) {
                    const possibleColumns = ['T√™n', 'H·ªç t√™n', 'Ho ten', 'Name', 'Ten', 'Full Name', 'H·ªç v√† t√™n'];
                    for (const col of possibleColumns) {
                        if (allUsersData[0].hasOwnProperty(col)) {
                            nameColumn = col;
                            break;
                        }
                    }
                    if (!nameColumn) {
                        nameColumn = Object.keys(allUsersData[0])[0];
                    }
                }
                
                const user = allUsersData.find(u => u[nameColumn] && u[nameColumn].toLowerCase() === name.toLowerCase());
                if (user) {
                    const today = new Date().getDay();
                    const dayMapping = ['Ch·ªß Nh·∫≠t', 'Th·ª©2', 'Th·ª©3', 'Th·ª©4', 'Th·ª©5', 'Th·ª©6', 'Th·ª© 7'];
                    const currentDayKey = (today >= 2 && today <= 6) ? dayMapping[today] : 'Th·ª©2';
                    userNameDisplay.innerText = user[nameColumn];
                    userInfoDisplay.innerText = user[currentDayKey] || 'Kh√¥ng c√≥ th√¥ng tin cho ng√†y h√¥m nay.';
                    addDebugMessage(`Hi·ªÉn th·ªã th√¥ng tin cho: ${user[nameColumn]}`);
                } else {
                    userNameDisplay.innerText = 'Kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c';
                    userInfoDisplay.innerText = 'Vui l√≤ng gi·ªØ khu√¥n m·∫∑t ·ªïn ƒë·ªãnh trong khung h√¨nh.';
                    addDebugMessage(`Kh√¥ng t√¨m th·∫•y user: ${name}`);
                }
            }

            async function run() {
                try {
                    await Promise.all([loadModels(), loadUserDataFromExcel()]);
                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    
                    addDebugMessage(`Thi·∫øt b·ªã: ${isMobile ? 'Mobile' : 'Desktop'}`);
                    
                    if (isMobile) {
                        cameraContainer.classList.remove('hidden');
                        startCamera();
                        const labeledFaceDescriptors = await createLabeledFaceDescriptors();
                        
                        if (labeledFaceDescriptors.length === 0) {
                            loader.innerText = "L·ªói: Kh√¥ng c√≥ d·ªØ li·ªáu khu√¥n m·∫∑t n√†o ƒë∆∞·ª£c x·ª≠ l√Ω. Ki·ªÉm tra Debug Info b√™n d∆∞·ªõi.";
                            addDebugMessage('‚ùå KH√îNG C√ì KHU√îN M·∫∂T N√ÄO ƒê∆Ø·ª¢C X·ª¨ L√ù TH√ÄNH C√îNG!');
                            return;
                        }
                        
                        const faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.55);
                        loader.classList.add('hidden');
                        addDebugMessage('üéâ Kh·ªüi ƒë·ªông ho√†n t·∫•t, b·∫Øt ƒë·∫ßu nh·∫≠n di·ªán...');
                        
                        let detectionActive = false;
                        
                        video.addEventListener('loadedmetadata', () => {
                            addDebugMessage('‚úÖ Video metadata loaded');
                            setTimeout(() => {
                                addDebugMessage('B·∫Øt ƒë·∫ßu detection loop...');
                                detectionActive = true;
                                detectFaces();
                            }, 1000); // ƒê·ª£i 1 gi√¢y ƒë·ªÉ video ·ªïn ƒë·ªãnh
                        });
                        
                        async function detectFaces() {
                            if (!detectionActive) return;
                            
                            try {
                                addDebugMessage('üîç ƒêang th·ª≠ detect khu√¥n m·∫∑t...');
                                const detection = await faceapi.detectSingleFace(video, new faceapi.SsdMobilenetv1Options({ minConfidence: 0.5 }))
                                    .withFaceLandmarks()
                                    .withFaceDescriptor();
                                
                                if (detection) {
                                    addDebugMessage('‚úÖ Ph√°t hi·ªán khu√¥n m·∫∑t!');
                                    const bestMatch = faceMatcher.findBestMatch(detection.descriptor);
                                    addDebugMessage(`üéØ Best match: ${bestMatch.label} (distance: ${bestMatch.distance.toFixed(2)})`);
                                    
                                    if (bestMatch.distance < 0.6) { // Threshold ƒë·ªÉ ch·∫•p nh·∫≠n
                                        displayUserInfo(bestMatch.label);
                                    } else {
                                        addDebugMessage('‚ö†Ô∏è Distance qu√° cao, kh√¥ng ch·∫•p nh·∫≠n match');
                                        userNameDisplay.innerText = 'Kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c';
                                        userInfoDisplay.innerText = 'Vui l√≤ng gi·ªØ khu√¥n m·∫∑t ·ªïn ƒë·ªãnh trong khung h√¨nh.';
                                    }
                                } else {
                                    addDebugMessage('‚ùå Kh√¥ng ph√°t hi·ªán ƒë∆∞·ª£c khu√¥n m·∫∑t');
                                }
                            } catch (error) {
                                addDebugMessage(`‚ùå L·ªói detection: ${error.message}`);
                            }
                            
                            // L·∫∑p l·∫°i sau 1 gi√¢y
                            setTimeout(detectFaces, 1000);
                        }
                    } else {
                        desktopContainer.classList.remove('hidden');
                        loader.classList.add('hidden');
                        addDebugMessage('Desktop mode - s·∫µn s√†ng nh·∫≠n input');
                        
                        nameInput.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') {
                                const name = nameInput.value.trim();
                                if (name) {
                                    // T√¨m t√™n c·ªôt
                                    let nameColumn = 'T√™n';
                                    if (allUsersData.length > 0) {
                                        const possibleColumns = ['T√™n', 'H·ªç t√™n', 'Ho ten', 'Name', 'Ten', 'Full Name', 'H·ªç v√† t√™n'];
                                        for (const col of possibleColumns) {
                                            if (allUsersData[0].hasOwnProperty(col)) {
                                                nameColumn = col;
                                                break;
                                            }
                                        }
                                        if (!nameColumn) {
                                            nameColumn = Object.keys(allUsersData[0])[0];
                                        }
                                    }
                                    
                                    const userFound = allUsersData.find(u => 
                                        u[nameColumn] && (
                                            u[nameColumn].toLowerCase() === name.toLowerCase() || 
                                            removeDiacritics(u[nameColumn]).toLowerCase() === name.toLowerCase()
                                        )
                                    );
                                    if (userFound) {
                                        displayUserInfo(userFound[nameColumn]);
                                    } else {
                                        userNameDisplay.innerText = 'Kh√¥ng t√¨m th·∫•y';
                                        userInfoDisplay.innerText = 'Vui l√≤ng ki·ªÉm tra l·∫°i t√™n ƒë√£ nh·∫≠p.';
                                        addDebugMessage(`Kh√¥ng t√¨m th·∫•y: "${name}"`);
                                    }
                                }
                            }
                        });
                    }
                } catch (error) {
                    addDebugMessage(`‚ùå L·ªói nghi√™m tr·ªçng: ${error.message}`);
                    console.error("ƒê√£ c√≥ l·ªói nghi√™m tr·ªçng x·∫£y ra khi kh·ªüi t·∫°o ·ª©ng d·ª•ng.", error);
                }
            }
            
            run();
        });
    </script>
</body>
</html>
